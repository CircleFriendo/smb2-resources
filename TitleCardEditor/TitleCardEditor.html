<!DOCTYPE html>
<html>
<head>
<title>SMB2 Title Card Editor</title>
</head>
<body>

<canvas id='canvas' width='512' height='576'></canvas>
<textarea id='table' rows='11' cols='80'></textarea>
<button onclick="processTable();">Update</button>

<script>
let image = new Image();
image.src = 'tiles.png';
image.addEventListener('load', redrawSource);

const tileWidth = 8, tileHeight = 8;
const mapRows = 10, mapColumns = 16;
const sourceWidth = 128, sourceHeight = 64;

const scale = 4;


let tiles = new Array(mapColumns*mapRows);
initializeTiles();
let mapHeight = mapRows * tileHeight;
let mapWidth = mapColumns * tileWidth;
let sourceX, sourceY, sourceTile;

let textarea = document.getElementById('table');

let canvas = document.getElementById('canvas');
let context = canvas.getContext('2d');

context.scale(scale, scale);


canvas.addEventListener('click', doMouseClick);
canvas.addEventListener('mousemove', doMouseMove);


function initializeTiles() {
    for (let i=0; i<mapColumns*mapRows; i++) {
            tiles[i]=251;
        }
}

function redrawSource() {
    context.drawImage(image, 0, 0, sourceWidth, sourceHeight, 0, mapHeight, sourceWidth, sourceHeight);
    fillTarget();
    fillTable();
}

function doMouseClick(e) {
    const rect = canvas.getBoundingClientRect();
    
    let x = (e.clientX- rect.left) / scale;
    let y = (e.clientY - rect.top) / scale;
    let gridX = Math.floor(x/tileWidth) * tileWidth;
    let gridY = Math.floor(y/tileHeight) * tileHeight;
    
    // select tile from source image
    if (y > mapHeight && y < (mapHeight+sourceHeight) && x < sourceWidth) {
        let tileX = Math.floor(x/tileWidth);
        let tileY = Math.floor((y-mapHeight)/tileHeight);
        sourceTile = tileY * (sourceWidth / tileWidth) + tileX;
        sourceX = gridX;
        sourceY = gridY - mapHeight;
    }
    
    // place tile on target image
    if (y<mapHeight && x<mapWidth) {
        context.clearRect(gridX, gridY, tileWidth, tileHeight);
        context.drawImage(image, sourceX, sourceY, tileWidth, tileHeight, gridX, gridY, tileWidth, tileHeight);
        let tileX = Math.floor(x/tileWidth);
        let tileY = Math.floor(y/tileHeight);
        let targetTile = tileY * mapColumns + tileX;
        tiles[targetTile] = sourceTile+128;
        
        fillTable();
        
    }
}

function hexcode(tile) {
    return '$'+(tile).toString(16);
}

function placeTile(x, y, tile) {
    var xpos = x*tileWidth;
    var ypos = y*tileHeight;
    
    var xs = tile%16;
    var ys = Math.floor((tile-128)/16);
    
    var xspos = xs*tileWidth;
    var yspos = ys*tileHeight;
    
    context.clearRect(xpos, ypos, tileWidth, tileHeight);
    context.drawImage(image, xspos, yspos, tileWidth, tileHeight, xpos, ypos, tileWidth, tileHeight);
}

function fillTarget() {
    let k = 0;
    for (let i=0; i<mapRows; i++) {
        for (let j=0; j<mapColumns; j++) {
            placeTile(j,i,tiles[k]);
            k++;
        }
    }   
}

function fillTable() {
    document.getElementById('table').value = constructString();
}

function parseTable() {
    var text = document.getElementById('table').value;
    var values = text.replace(/^db /mg, '').replace(/\$/g,'').trim().split(/[\s,]+/);
    for (var k=0; k<160; k++) {
        tiles[k] = parseInt(values[k],16);
    }
}

function processTable() {
    parseTable();
    fillTarget();
}

function constructString() {
    let string = '';
    let k = 0;
    for (let i=0; i<mapRows; i++) {
        string += "db ";
        for (let j=0; j<mapColumns; j++) {
            string += hexcode(tiles[k]);
            if (j!=mapColumns-1) {
                string += ',';
            }
            k++;
        }
        string += "\n";
    }
    return string;
}

function doMouseMove(e) {

}

</script>
</body>
</html>